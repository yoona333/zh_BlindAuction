# BlindAuction 联调测试指南

> 本文档提供完整的前端与合约联调测试流程，确保所有功能正常工作。

**测试日期**: 2026-02-15
**测试网络**: Sepolia Testnet
**前端环境**: React + Vite
**FHEVM 模式**: 真实模式（非 Mock）

---

## ✅ 前置检查（已完成）

### 1. 合约部署状态

| 合约 | 地址 | 状态 |
|------|------|------|
| MySecretToken | `0xAE4b8A28B69Ab86fb905Fc535e0F4B27bbe59243` | ✅ 已部署 |
| TokenExchange | `0xE1cD84947a301805229A1dE84B4Ca292600Ef0C6` | ✅ 已部署 |
| BlindAuction | `0x88C7976536790fB3918058a219CeD80093AeCEC9` | ✅ 已部署 |

**验证链接**: https://sepolia.etherscan.io/

### 2. 前端配置验证

- ✅ 合约地址配置正确（`zh-blindauction/src/config/contracts.ts`）
- ✅ Gas Limit 已优化
- ✅ FHEVM 配置正常
- ✅ Supabase 已配置

### 3. Gas Limit 优化汇总

| 功能 | Gas Limit | 预估费用 (5 Gwei) |
|------|-----------|-------------------|
| 创建拍卖 | 300,000 | ~0.0015 ETH |
| 领取拍卖 | 500,000 | ~0.0025 ETH |
| 出价 | 自动估算 | ~0.002-0.003 ETH |
| 确认发货 | 300,000 | ~0.0015 ETH |
| 确认收货 | 300,000 | ~0.0015 ETH |
| 提取托管 | 300,000 | ~0.0015 ETH |
| 发起争议 | 300,000 | ~0.0015 ETH |
| 提取押金 | 300,000 | ~0.0015 ETH |
| 代币授权 | 200,000 | ~0.001 ETH |

---

## 🧪 完整测试流程

### 准备工作

#### 1. 启动前端开发服务器
```bash
cd zh-blindauction
npm run dev
```

访问：http://localhost:5173

#### 2. 准备测试账户

**至少需要 2 个 MetaMask 账户**：
- **账户 A**：卖家（创建拍卖）
- **账户 B**：买家（出价和领取）

**每个账户需要**：
- 至少 **0.1 SepoliaETH**（用于 Gas 费和挂单费）
- 可从水龙头获取：https://sepoliafaucet.com/

#### 3. 连接钱包

1. 打开前端页面
2. 点击右上角"Connect Wallet"
3. 选择 MetaMask
4. 确认网络切换到 Sepolia

---

## 📝 测试用例 1：购买 SAT 代币

### 目的
测试 ETH → SAT 代币兑换功能

### 步骤

1. **导航到 Tokens 页面**
   - 点击顶部导航栏的"Tokens"

2. **购买 SAT 代币**
   - 在"Buy SAT Tokens"区域
   - 输入金额：`0.01` ETH
   - 计算结果应显示：`10,000 SAT`
   - 点击"Buy Tokens"

3. **确认交易**
   - MetaMask 弹窗
   - Gas 费：约 0.001 ETH
   - 总计：0.011 ETH
   - 点击"确认"

4. **等待确认**
   - 页面显示"交易处理中"
   - 等待约 10-30 秒
   - 成功后显示"购买成功"

5. **验证余额**
   - 点击"Reveal Balance"按钮
   - 签名消息（MetaMask 弹窗）
   - 应显示：`10,000 SAT`

### 预期结果
- ✅ 交易成功
- ✅ 余额显示正确
- ✅ 无报错

---

## 📝 测试用例 2：授权 BlindAuction 合约

### 目的
授权 BlindAuction 合约可以转移你的 SAT 代币（出价需要）

### 步骤

1. **在 Tokens 页面**
   - 找到"Manage Operator"区域

2. **授权合约**
   - Operator 地址已预填：`0x88C7976536790fB3918058a219CeD80093AeCEC9`
   - 点击"Approve Operator"

3. **确认交易**
   - Gas 费：约 0.001 ETH
   - 点击"确认"

4. **等待确认**
   - 成功后显示"授权成功"

### 预期结果
- ✅ 授权成功
- ✅ 可以进行出价操作

---

## 📝 测试用例 3：创建拍卖（账户 A）

### 目的
测试卖家创建拍卖功能

### 步骤

1. **导航到 Create Auction 页面**
   - 点击"Create Auction"

2. **填写拍卖信息**
   - **标题**：`测试拍卖 - iPhone 15 Pro`
   - **描述**：`全新 iPhone 15 Pro，256GB，深空黑`
   - **上传图片**：选择一张图片（会上传到 IPFS）
   - **起拍价**：`1000` SAT
   - **开始时间**：当前时间（或稍后）
   - **结束时间**：1 小时后

3. **点击"Create Auction"**

4. **确认交易**
   - MetaMask 弹窗
   - **挂单费**：0.01 ETH
   - **Gas 费**：约 0.0015 ETH
   - **总计**：约 0.0115 ETH
   - 点击"确认"

5. **等待确认**
   - IPFS 上传中...
   - 交易处理中...
   - 成功后跳转到拍卖列表

6. **验证创建**
   - 在 Auctions 页面找到刚创建的拍卖
   - 状态应为"Active"（如果开始时间已到）

### 预期结果
- ✅ 拍卖创建成功
- ✅ 图片上传到 IPFS
- ✅ 拍卖显示在列表中
- ✅ 费用合理（约 0.0115 ETH）

---

## 📝 测试用例 4：出价（账户 B）

### 目的
测试买家加密出价功能（FHEVM 核心功能）

### 前提
- 账户 B 已购买 SAT 代币（至少 1500 SAT）
- 账户 B 已授权 BlindAuction 合约

### 步骤

1. **切换到账户 B**
   - MetaMask 切换账户

2. **找到拍卖**
   - 在 Auctions 页面找到刚创建的拍卖
   - 点击进入详情页

3. **出价**
   - 在"Place Bid"区域
   - 输入出价：`1500` SAT（必须 ≥ 起拍价 1000）
   - 点击"Place Bid"

4. **FHEVM 加密过程**
   - 页面显示"加密出价中..."
   - 等待 FHEVM 初始化（首次可能需要 10-20 秒）
   - 加密完成后自动提交交易

5. **确认交易**
   - Gas 费：约 0.002-0.003 ETH（FHEVM 操作消耗较高）
   - 点击"确认"

6. **等待确认**
   - 成功后显示"出价成功"
   - **重要**：你看不到自己的出价金额（加密的）

### 预期结果
- ✅ 出价成功
- ✅ 出价金额被加密（看不到具体数字）
- ✅ 无报错

---

## 📝 测试用例 5：领取拍卖（账户 B）

### 目的
测试获胜者领取拍卖功能

### 前提
- 拍卖已结束（等待结束时间到达，或手动修改结束时间为过去的时间）
- 账户 B 是出价最高者

### 步骤

1. **等待拍卖结束**
   - 状态变为"Ended"

2. **领取拍卖**
   - 在拍卖详情页
   - 点击"Claim Auction"

3. **确认交易**
   - **押金**：0.05 ETH
   - **Gas 费**：约 0.0025 ETH
   - **总计**：约 0.0525 ETH
   - 点击"确认"

4. **等待确认**
   - SAT 代币进入托管
   - 状态变为"Claimed"

5. **验证**
   - 你的 SAT 余额应减少（1500 SAT 进入托管）
   - 你支付了 0.05 ETH 押金

### 预期结果
- ✅ 领取成功
- ✅ 代币进入托管
- ✅ 押金已支付
- ✅ 状态更新为"Claimed"

---

## 📝 测试用例 6：确认发货（账户 A）

### 目的
测试卖家确认发货功能

### 步骤

1. **切换到账户 A（卖家）**

2. **导航到 Orders 页面**
   - 点击"Orders"
   - 找到已被领取的拍卖

3. **确认发货**
   - 点击"Confirm Shipment"
   - 输入物流单号：`SF1234567890`
   - 点击"Submit"

4. **确认交易**
   - Gas 费：约 0.0015 ETH
   - 点击"确认"

5. **等待确认**
   - 成功后状态变为"Delivered"

### 预期结果
- ✅ 发货确认成功
- ✅ 物流信息已记录
- ✅ 状态更新为"Delivered"

---

## 📝 测试用例 7：确认收货（账户 B）

### 目的
测试买家确认收货功能

### 步骤

1. **切换到账户 B（买家）**

2. **导航到 Orders 页面**

3. **确认收货**
   - 找到已发货的订单
   - 点击"Confirm Receipt"

4. **确认交易**
   - Gas 费：约 0.0015 ETH
   - 点击"确认"

5. **等待确认**
   - 押金退还（0.05 ETH）
   - 托管的 SAT 代币支付给卖家：
     - 卖家收到：`1350 SAT`（90%）
     - 平台收取：`150 SAT`（10% 手续费）
   - 状态变为"Completed"

### 预期结果
- ✅ 确认收货成功
- ✅ 押金已退还（0.05 ETH）
- ✅ 卖家收到 90% 的 SAT
- ✅ 状态更新为"Completed"

---

## 📝 测试用例 8：提取押金（可选）

### 目的
测试失败者提取押金功能

### 前提
- 你调用了 `claim()` 但不是真正的赢家
- 或者你是赢家但想提前取回押金

### 步骤

1. **在 Orders 页面**
   - 找到有押金的拍卖

2. **提取押金**
   - 点击"Withdraw Stake"

3. **确认交易**
   - Gas 费：约 0.0015 ETH
   - 点击"确认"

4. **等待确认**
   - 0.05 ETH 押金退还

### 预期结果
- ✅ 押金成功退还

---

## 🐛 常见问题排查

### 问题 1：FHEVM 初始化失败
**症状**: 出价时显示"FHEVM 未初始化"

**解决**:
1. 刷新页面
2. 等待 10-20 秒让 FHEVM 初始化
3. 检查浏览器控制台是否有错误
4. 确保使用 Chrome/Firefox 最新版本

### 问题 2：交易失败 - Gas limit too high
**症状**: MetaMask 显示"gas limit too high"

**解决**:
- 已修复！Gas limit 已优化到合理范围
- 刷新页面重新尝试

### 问题 3：出价后看不到金额
**症状**: 出价后显示"encrypted"

**说明**:
- 这是**正常的**！出价金额是加密的
- 只有在领取（claim）时合约才会比较加密的出价
- 这是 FHEVM 的核心特性

### 问题 4：无法领取拍卖
**症状**: 点击 Claim 后交易失败

**可能原因**:
1. 你不是出价最高者
2. 拍卖还未结束
3. SAT 代币余额不足
4. 未授权 BlindAuction 合约

**解决**:
- 检查拍卖状态
- 确保已购买足够的 SAT 代币
- 确保已授权合约

### 问题 5：余额显示 "Encrypted"
**症状**: SAT 余额一直显示 "Encrypted"

**解决**:
1. 点击"Reveal Balance"
2. 签名消息（MetaMask 弹窗）
3. 等待解密完成（约 3-5 秒）

---

## ✅ 测试检查清单

完成以下所有测试后，前后端联调即完成：

- [ ] 购买 SAT 代币
- [ ] 授权 BlindAuction 合约
- [ ] 创建拍卖（Gas 费合理）
- [ ] 出价（FHEVM 加密成功）
- [ ] 领取拍卖（押金支付成功）
- [ ] 确认发货（物流信息记录）
- [ ] 确认收货（押金退还 + 代币支付）
- [ ] 提取押金（可选）

---

## 📊 性能指标

### Gas 费用汇总（Sepolia 测试网，5 Gwei）

| 操作 | 预估费用 | 实际消耗 |
|------|---------|---------|
| 购买 SAT | ~0.001 ETH | ✅ 待测试 |
| 授权合约 | ~0.001 ETH | ✅ 待测试 |
| 创建拍卖 | ~0.0015 ETH | ✅ 待测试 |
| 出价 | ~0.002-0.003 ETH | ✅ 待测试 |
| 领取拍卖 | ~0.0025 ETH | ✅ 待测试 |
| 确认发货 | ~0.0015 ETH | ✅ 待测试 |
| 确认收货 | ~0.0015 ETH | ✅ 待测试 |

### FHEVM 性能

| 操作 | 预估时间 |
|------|---------|
| FHEVM 初始化 | 10-20 秒（首次） |
| 加密出价 | 2-5 秒 |
| 解密余额 | 3-5 秒 |

---

## 🎯 下一步

联调测试完成后：

1. **记录测试结果**
   - 填写上方的检查清单
   - 记录实际的 Gas 消耗

2. **修复发现的问题**
   - 如有 Bug，记录并修复

3. **准备部署到主网**（未来）
   - 进行安全审计
   - 优化合约代码
   - 准备应急方案

---

**测试人员**: [你的名字]
**测试日期**: 2026-02-15
**测试环境**: Sepolia Testnet
**测试结果**: ⏳ 待测试

---

**祝测试顺利！** 🎉

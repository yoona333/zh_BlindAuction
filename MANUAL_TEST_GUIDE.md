# BlindAuction 手动测试完整流程

> 本文档提供完整的手动测试流程，帮助你验证 BlindAuction 平台的所有核心功能。

## 📋 测试前准备

### 1. 环境检查

**所需工具**:
- ✅ Chrome/Brave 浏览器（推荐）
- ✅ MetaMask 钱包插件
- ✅ 至少 3 个 Sepolia 测试账户（模拟不同角色）

**测试账户角色分配**:
- **账户 A**: 管理员 + 卖家
- **账户 B**: 买家 1（竞拍者）
- **账户 C**: 买家 2（竞拍者）

### 2. 获取 Sepolia 测试币

每个账户都需要一些 Sepolia ETH：

1. 访问水龙头网站：
   - https://sepoliafaucet.com/
   - https://www.alchemy.com/faucets/ethereum-sepolia

2. 输入账户地址，获取测试币（通常 0.5 ETH 足够）

3. 验证到账：
   ```
   打开 MetaMask → 查看余额（确保 > 0.2 ETH）
   ```

### 3. 启动前端应用

```bash
# 在项目根目录执行
npm run start
```

浏览器会自动打开 `http://localhost:5173`

---

## 🎯 测试流程

### 阶段 1: 初始化设置（使用账户 A - 管理员）

#### 1.1 连接钱包

**操作步骤**:
1. 打开应用首页
2. 点击右上角 "连接钱包" 按钮
3. MetaMask 弹窗 → 选择账户 A → 确认连接
4. 验证右上角显示账户地址（如 `0x1234...5678`）

**检查点**:
- ✅ 地址正确显示
- ✅ 网络显示为 "Sepolia"
- ✅ 页面菜单项全部可见

**故障排除**:
- 如果连接失败，检查 MetaMask 是否切换到 Sepolia 网络
- 如果一直加载，打开浏览器控制台查看 "FHEVM initialized" 日志（需等待 10-15 秒）

---

#### 1.2 设置管理员权限（仅首次）

**操作步骤**:
1. 导航到 "管理面板"（Admin）页面
2. 在 "管理员设置" 区域，输入账户 A 的地址
3. 点击 "授予管理员权限"
4. MetaMask 弹窗 → 确认交易 → 等待确认（约 15-30 秒）

**检查点**:
- ✅ 交易成功（页面显示成功提示）
- ✅ 账户 A 在 "当前管理员列表" 中显示

**为什么需要这一步**:
- 管理员可以处理争议、强制结束拍卖
- 生产环境中，管理员权限由合约所有者（部署者）授予

---

#### 1.3 兑换 SAT 代币（给所有账户）

**背景知识**:
- BlindAuction 使用加密代币 SAT (Secret Auction Token) 进行出价
- SAT 是 ERC7984 标准的全同态加密代币
- 出价金额以加密形式存储，其他用户无法看到具体数值

**操作步骤（对每个账户重复）**:

1. 切换到对应账户（MetaMask → 切换账户）
2. 导航到 "代币管理"（Token Management）页面
3. 在 "购买 SAT 代币" 区域：
   - 输入兑换数量，如 `100`（表示用 100 ETH 兑换 100 SAT）
   - ⚠️ 注意：测试网输入 `0.1` 即可（兑换 0.1 SAT）
4. 点击 "购买 SAT"
5. MetaMask 弹窗 → 确认交易（会扣除等值 ETH）
6. 等待交易确认（约 15-30 秒）
7. 页面显示成功提示

**建议兑换数量**:
- 账户 A（卖家）：0.05 SAT（用于测试购买）
- 账户 B（买家 1）：0.1 SAT（用于竞拍）
- 账户 C（买家 2）：0.15 SAT（用于竞拍）

**检查点**:
- ✅ ETH 余额减少（如兑换 0.1 SAT，ETH 减少约 0.1）
- ✅ 页面显示 "SAT 余额已更新"
- ✅ 可在 "我的 SAT 余额" 区域查看（加密余额，显示为密文）

**技术细节**:
- SAT 余额是加密的 `euint64` 类型，前端无法直接读取明文
- 如需查看明文余额，需点击 "解密余额" 并用钱包签名授权
- 这是 FHEVM 的核心特性：链上存储加密数据，保护隐私

---

### 阶段 2: 创建拍卖（使用账户 A - 卖家）

#### 2.1 填写拍卖信息

**操作步骤**:
1. 确保当前账户为账户 A（卖家）
2. 导航到 "创建拍卖"（Create Auction）页面
3. 填写表单：

**表单字段详解**:

| 字段 | 示例值 | 说明 |
|------|--------|------|
| **拍卖标题** | iPhone 15 Pro 256GB 深空黑 | 简洁明了，包含核心信息 |
| **详细描述** | 全新未拆封，国行正品，支持官方验机... | 详细描述商品状态、配件、售后等 |
| **图片 URL** | https://example.com/iphone.jpg | 可使用图床链接或留空 |
| **起拍价** | 50 | 单位：SAT（加密代币），建议设置较低起拍价吸引竞拍 |
| **一口价** | 100 | 买家可选择直接以此价格购买，立即结束拍卖 |
| **开始时间** | 2026-02-08 15:00 | 点击日期选择器，选择未来时间（如 5 分钟后） |
| **结束时间** | 2026-02-08 16:00 | 必须晚于开始时间，建议至少 30 分钟后 |
| **卖家联系方式** | WeChat: seller123 | 可填写微信、QQ、邮箱等（可选） |

**⚠️ 重要提示**:
- 开始时间必须晚于当前时间（至少 1 分钟后）
- 结束时间必须晚于开始时间
- 起拍价和一口价使用 SAT 代币，不是 ETH
- 创建拍卖需支付 0.01 ETH 挂单费（防止垃圾拍卖）

---

#### 2.2 提交拍卖

**操作步骤**:
1. 填写完毕后，点击 "创建拍卖" 按钮
2. MetaMask 弹窗 → 确认交易
   - Gas Fee: 约 0.005 ETH
   - 挂单费: 0.01 ETH
   - 总计: 约 0.015 ETH
3. 等待交易确认（约 15-30 秒）
4. 页面自动跳转到 "我的拍卖" 页面

**检查点**:
- ✅ 交易成功（页面显示成功提示）
- ✅ 在 "我的拍卖" 中看到刚创建的拍卖
- ✅ 拍卖状态显示为 "待开始"（Pending）
- ✅ ETH 余额减少约 0.015

**故障排除**:
- 如果交易失败，检查：
  - ETH 余额是否 > 0.02（需覆盖挂单费 + Gas）
  - 时间设置是否合法
  - MetaMask 是否切换到 Sepolia 网络

---

#### 2.3 查看拍卖详情

**操作步骤**:
1. 在 "我的拍卖" 页面，找到刚创建的拍卖
2. 点击 "查看详情" 按钮
3. 进入拍卖详情页面

**详情页内容**:
- **商品信息**: 标题、描述、图片
- **价格信息**: 起拍价、一口价、当前出价（初始为 0）
- **时间信息**: 倒计时显示（如 "4分30秒后开始"）
- **状态信息**: 当前状态（Pending）
- **卖家信息**: 卖家地址、联系方式

**检查点**:
- ✅ 所有信息显示正确
- ✅ 倒计时正常运行
- ✅ 状态为 "待开始"（Pending）

---

### 阶段 3: 竞拍流程（使用账户 B 和 C - 买家）

#### 3.1 等待拍卖开始

**时间机制说明**:
- 拍卖状态由**区块链时间**（`block.timestamp`）控制
- 前端显示的倒计时基于**浏览器时间**，仅供参考
- 修改浏览器时间**不会影响**拍卖实际状态

**操作步骤**:
1. 等待拍卖开始时间到达（如设置的 15:00）
2. 刷新页面或等待自动刷新
3. 拍卖状态变为 "进行中"（Active）

**检查点**:
- ✅ 拍卖状态从 "待开始" 变为 "进行中"
- ✅ 可以进行出价操作
- ✅ 倒计时显示剩余时间（如 "55分30秒后结束"）

**如何加速测试**:
- 创建拍卖时，设置开始时间为 **1 分钟后**
- 设置结束时间为 **3 分钟后**
- 这样可以快速测试完整流程

---

#### 3.2 买家 1 出价（账户 B）

**操作步骤**:
1. MetaMask 切换到账户 B
2. 刷新页面，重新连接钱包（或点击右上角账户切换）
3. 导航到 "拍卖列表"（Auctions）页面
4. 找到刚创建的拍卖，点击 "查看详情"
5. 在拍卖详情页，找到 "出价" 区域
6. 输入出价金额：`60`（单位：SAT，高于起拍价 50）
7. 点击 "出价" 按钮

**出价流程详解**:

1. **第一步：授权代币**
   - 首次出价需要授权 BlindAuction 合约使用你的 SAT 代币
   - MetaMask 弹窗 → 确认 "Approve" 交易
   - 等待确认（约 15 秒）

2. **第二步：提交出价**
   - 授权成功后，自动触发出价交易
   - MetaMask 再次弹窗 → 确认 "Bid" 交易
   - 等待确认（约 15-30 秒）

**检查点**:
- ✅ 授权交易成功
- ✅ 出价交易成功（页面显示 "出价成功"）
- ✅ 页面显示 "你是当前最高出价者"
- ✅ SAT 余额减少（如从 0.1 变为 0.04）

**技术细节**:
- 出价金额以**加密形式**存储在链上
- 其他用户无法看到你的具体出价（显示为 "已加密"）
- 只有拍卖结束后，赢家才能解密最终价格

---

#### 3.3 买家 2 竞价（账户 C）

**操作步骤**:
1. MetaMask 切换到账户 C
2. 刷新页面，重新连接钱包
3. 导航到同一拍卖详情页
4. 输入更高的出价：`80`（高于买家 1 的 60）
5. 点击 "出价" 按钮
6. 重复授权 + 出价流程（同上）

**检查点**:
- ✅ 账户 C 成为新的最高出价者
- ✅ 账户 B 在详情页看到 "你已被超出"
- ✅ 页面显示 "当前最高出价已加密"（具体金额对卖家和其他买家保密）

**竞价策略测试**:
- 可多次切换账户 B 和 C，模拟真实竞价场景
- 每次出价必须高于当前最高价
- 如果出价低于或等于当前价，交易会失败（智能合约会拒绝）

---

#### 3.4 测试一口价购买（可选）

**操作步骤**:
1. 切换到账户 B 或 C
2. 在拍卖详情页，点击 "一口价购买" 按钮
3. 确认弹窗 → 支付一口价（如 100 SAT）
4. MetaMask 确认交易

**结果**:
- ✅ 拍卖立即结束（状态变为 Ended）
- ✅ 购买者成为赢家
- ✅ 其他出价者的 SAT 自动退回

**注意**:
- 一口价购买会立即结束拍卖，跳过倒计时
- 这是快速成交的方式，适合买家急需商品

---

### 阶段 4: 拍卖结束与交付（账户 C 赢家 + 账户 A 卖家）

#### 4.1 等待拍卖结束

**操作步骤**:
1. 等待拍卖结束时间到达（如设置的 16:00）
2. 刷新页面
3. 拍卖状态自动变为 "已结束"（Ended）

**检查点**:
- ✅ 状态从 "进行中" 变为 "已结束"
- ✅ 出价按钮消失
- ✅ 页面显示 "拍卖已结束，等待赢家领取"

---

#### 4.2 赢家领取拍卖（账户 C）

**操作步骤**:
1. 切换到账户 C（赢家）
2. 导航到 "我的拍卖" 页面
3. 找到该拍卖，点击 "查看详情"
4. 在详情页，点击 "领取拍卖" 按钮
5. MetaMask 弹窗 → 确认交易
   - 需支付 0.05 ETH 押金（用于保证收货确认）
6. 等待交易确认

**检查点**:
- ✅ 交易成功（页面显示 "领取成功"）
- ✅ 拍卖状态变为 "已领取"（Claimed）
- ✅ 账户 C 的 ETH 余额减少约 0.05
- ✅ 页面显示卖家联系方式（如 WeChat: seller123）

**为什么需要押金**:
- 押金确保买家不会恶意领取后不确认收货
- 确认收货后，押金会全额退回
- 如果发生争议，管理员可裁决押金归属

---

#### 4.3 卖家确认发货（账户 A）

**操作步骤**:
1. 切换到账户 A（卖家）
2. 导航到 "我的拍卖" 页面
3. 找到该拍卖，点击 "查看详情"
4. 在 "物流操作" 区域：
   - 输入快递单号，如 `SF1234567890`
   - 输入物流公司，如 `顺丰速运`
   - 输入预计送达时间，如 `2026-02-10 18:00`
5. 点击 "确认发货" 按钮
6. MetaMask 确认交易

**检查点**:
- ✅ 交易成功（页面显示 "发货成功"）
- ✅ 拍卖状态变为 "已发货"（Delivered）
- ✅ 买家可以看到物流信息

---

#### 4.4 买家确认收货（账户 C）

**操作步骤**:
1. 切换到账户 C（买家）
2. 进入拍卖详情页
3. 查看物流信息（快递单号、物流公司）
4. 点击 "确认收货" 按钮
5. MetaMask 确认交易

**资金结算流程**:
1. 买家的押金（0.05 ETH）退回到账户 C
2. 买家的出价（80 SAT）支付给卖家账户 A
3. 拍卖状态变为 "已完成"（Completed）

**检查点**:
- ✅ 账户 C 的 ETH 余额恢复（+0.05，扣除 Gas）
- ✅ 账户 A 的 SAT 余额增加（+80）
- ✅ 拍卖状态变为 "已完成"
- ✅ 页面显示 "交易已完成"

---

### 阶段 5: 争议处理（可选，使用账户 A 管理员）

#### 5.1 买家发起争议

**场景**:
- 买家收到商品后，发现货不对板
- 卖家未按时发货
- 物流丢失

**操作步骤**:
1. 切换到账户 C（买家）
2. 在拍卖详情页（状态为 Delivered），点击 "发起争议" 按钮
3. 填写争议原因，如 "商品与描述不符，要求退款"
4. MetaMask 确认交易

**检查点**:
- ✅ 拍卖状态变为 "争议中"（Disputed）
- ✅ 页面显示 "争议已提交，等待管理员处理"

---

#### 5.2 管理员裁决争议

**操作步骤**:
1. 切换到账户 A（管理员）
2. 导航到 "管理面板" 页面
3. 在 "争议处理" 区域，找到该拍卖
4. 查看争议详情（买家投诉内容、卖家说明等）
5. 做出裁决：
   - **Option 1**: 支持买家 → 押金 + 出价全部退回买家
   - **Option 2**: 支持卖家 → 押金退回买家，出价支付给卖家
   - **Option 3**: 折中方案 → 按比例分配（如 50%-50%）
6. 点击 "提交裁决" 按钮
7. MetaMask 确认交易

**检查点**:
- ✅ 资金按裁决结果分配
- ✅ 拍卖状态变为 "已完成"（Completed）
- ✅ 双方都收到裁决通知

---

## 🧪 高级测试场景

### 场景 1: 取消拍卖

**条件**: 拍卖状态为 Pending（未开始）且无人出价

**步骤**:
1. 卖家进入拍卖详情页
2. 点击 "取消拍卖" 按钮
3. MetaMask 确认交易

**结果**:
- ✅ 拍卖状态变为 "已取消"（Cancelled）
- ✅ 挂单费不退回（防止滥用）

---

### 场景 2: 出价退款

**条件**: 拍卖结束后，非赢家的买家

**自动退款**:
- 拍卖结束时，所有非赢家的出价自动解锁
- SAT 代币退回到买家账户（无需手动操作）

**验证**:
1. 切换到账户 B（出价 60 但被超出）
2. 检查 SAT 余额（应恢复到出价前的数量）

---

### 场景 3: 超时未领取

**条件**: 拍卖结束 7 天后，赢家未领取

**管理员强制结束**:
1. 管理员进入拍卖详情页
2. 点击 "强制结束" 按钮
3. 赢家的出价退回，拍卖状态变为 Cancelled

**测试方法**:
- 由于时间限制，无法等待 7 天
- 可修改智能合约的超时参数（如改为 1 分钟）并重新部署
- 或直接在 Remix 中调用 `forceEndAuction()` 函数

---

### 场景 4: 多拍卖并发测试

**步骤**:
1. 使用账户 A 创建 3 个不同的拍卖：
   - 拍卖 1: 起拍价 10，一口价 50
   - 拍卖 2: 起拍价 30，一口价 100
   - 拍卖 3: 起拍价 50，一口价 150
2. 使用账户 B 和 C 分别对不同拍卖出价
3. 验证每个拍卖的状态独立管理

**检查点**:
- ✅ 每个拍卖的出价记录互不影响
- ✅ 状态转换独立进行
- ✅ 资金结算正确（无串账）

---

## 📊 测试检查清单

使用此清单逐项验证功能：

### 基础功能
- [ ] 连接钱包成功
- [ ] FHEVM 初始化成功（控制台有日志）
- [ ] 网络切换到 Sepolia
- [ ] 3 个账户都有足够的 Sepolia ETH

### 代币管理
- [ ] 购买 SAT 代币成功
- [ ] ETH 余额正确减少
- [ ] 可以解密查看 SAT 余额（需签名）

### 拍卖创建
- [ ] 创建拍卖成功（支付 0.01 ETH 挂单费）
- [ ] 拍卖信息显示正确
- [ ] 拍卖状态初始为 Pending
- [ ] 倒计时正常显示

### 竞拍流程
- [ ] 拍卖到开始时间后状态变为 Active
- [ ] 首次出价需要授权代币
- [ ] 出价成功后成为最高出价者
- [ ] 第二个买家出价更高后成为新赢家
- [ ] 非赢家的出价被超出后正确显示
- [ ] 一口价购买可立即结束拍卖

### 交付流程
- [ ] 拍卖到结束时间后状态变为 Ended
- [ ] 赢家领取拍卖成功（支付 0.05 ETH 押金）
- [ ] 状态变为 Claimed
- [ ] 卖家确认发货成功（输入物流信息）
- [ ] 状态变为 Delivered
- [ ] 买家确认收货后资金正确结算（押金退回，SAT 支付给卖家）
- [ ] 状态变为 Completed

### 争议处理
- [ ] 买家可在 Delivered 状态发起争议
- [ ] 状态变为 Disputed
- [ ] 管理员可以查看争议详情
- [ ] 管理员裁决后资金按结果分配
- [ ] 状态变为 Completed

### 边界情况
- [ ] 出价低于起拍价会被拒绝
- [ ] 出价低于当前最高价会被拒绝
- [ ] 非卖家无法取消拍卖
- [ ] 非赢家无法领取拍卖
- [ ] 非卖家无法确认发货
- [ ] 非买家无法确认收货

---

## 🐛 常见问题排查

### 问题 1: FHEVM 一直加载

**症状**: 页面一直显示 "FHEVM 初始化中..."

**解决方法**:
1. 打开浏览器控制台（F12）
2. 查看是否有错误日志
3. 等待至少 30 秒（FHEVM 首次加载较慢）
4. 刷新页面重试
5. 如果仍失败，检查网络连接

---

### 问题 2: 交易一直 Pending

**症状**: MetaMask 显示交易已发送，但长时间未确认

**解决方法**:
1. 检查 Sepolia 网络是否拥堵（访问 https://sepolia.etherscan.io/）
2. 提高 Gas Price（MetaMask → 高级设置 → 自定义 Gas）
3. 等待更长时间（Sepolia 有时确认较慢，可能需 1-2 分钟）
4. 如果超过 5 分钟，考虑取消交易并重试

---

### 问题 3: 合约地址不匹配

**症状**: 交易失败，错误信息为 "Contract not found"

**解决方法**:
1. 运行 `npm run sync` 重新同步合约地址
2. 重启前端应用 `npm run start`
3. 清除浏览器缓存（Ctrl + Shift + Delete）
4. 检查 [contracts.ts](zh-blindauction/src/config/contracts.ts) 中的地址是否正确

---

### 问题 4: 无法解密 SAT 余额

**症状**: 点击 "解密余额" 后无响应或失败

**解决方法**:
1. 确保 FHEVM 已完全初始化（查看控制台日志）
2. 确保 MetaMask 已连接且在 Sepolia 网络
3. 重新连接钱包
4. 刷新页面重试

---

### 问题 5: 拍卖状态未自动更新

**症状**: 时间到了但状态仍为 Pending 或 Active

**解决方法**:
1. **手动刷新页面**（F5）
2. 前端倒计时仅供参考，实际状态由区块链控制
3. 检查区块链时间与浏览器时间的差异
4. 等待下一个区块确认（约 12-15 秒）

---

## 📈 性能基准

以下是在 Sepolia 测试网的典型性能指标：

| 操作 | 预期时间 | Gas 消耗 |
|------|---------|---------|
| FHEVM 初始化 | 10-15 秒 | - |
| 连接钱包 | 1-2 秒 | - |
| 购买 SAT | 15-30 秒 | ~0.01 ETH |
| 创建拍卖 | 15-30 秒 | ~0.015 ETH |
| 首次出价（授权 + 出价） | 30-60 秒 | ~0.02 ETH |
| 后续出价 | 15-30 秒 | ~0.01 ETH |
| 领取拍卖 | 15-30 秒 | ~0.055 ETH |
| 确认发货 | 15-30 秒 | ~0.01 ETH |
| 确认收货 | 15-30 秒 | ~0.01 ETH |

**注**: Gas 消耗会随网络拥堵情况波动，以上为平均值。

---

## 🎓 测试总结

完成以上测试流程后，你应该已经验证了：

✅ **核心功能**:
- FHEVM 加密代币系统
- 盲拍机制（加密出价）
- 完整的拍卖生命周期

✅ **安全机制**:
- 押金保证金制度
- 争议仲裁机制
- 管理员权限控制

✅ **用户体验**:
- 多语言支持（中英文切换）
- 主题切换（深色/浅色模式）
- 实时状态更新

✅ **区块链集成**:
- MetaMask 钱包连接
- Sepolia 测试网交互
- 交易确认与反馈

---

## 📞 技术支持

如在测试过程中遇到问题：

1. 查看浏览器控制台日志（F12 → Console）
2. 检查 [常见问题排查](#-常见问题排查) 部分
3. 访问 Sepolia Etherscan 查看交易详情
4. 参考项目文档（根目录的 .md 文件）

**外部资源**:
- Zama FHEVM 文档: https://docs.zama.ai/fhevm
- Sepolia Testnet 浏览器: https://sepolia.etherscan.io/
- MetaMask 支持: https://support.metamask.io/

---

**文档版本**: 1.0
**最后更新**: 2026-02-08
**适用版本**: BlindAuction v2.0.0
